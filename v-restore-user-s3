#!/bin/bash
# info: run User Restore Backup from S3
# options: BACKUP_URL BACKUP_ID ENVIRONMENT SCHEMA_ID
#
# example: v-restore-user-s3 https://s3.example.com/backup.tar 42 example.com 24
#
# This function runs restore script for given user backup URL.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

backup_url=$1
backup_id=$2
environment=$3
schema_id=$4

# Функция для вывода JSON ответа с ошибкой
error_response() {
    local error_message="$1"
    cat <<EOF
{
  "backup_url": "$backup_url",
  "backup_id": "$backup_id",
  "schema_id": "$schema_id",
  "status": "error",
  "message": "$error_message",
  "pid": null
}
EOF
    exit 1
}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Logging Setup                         #
#----------------------------------------------------------#

LOG_ROOT="/backup_restore"
LOG_DIR="$LOG_ROOT/schema_${schema_id}"
LOG_FILE="$LOG_DIR/v-restore-user.log"

# Проверяем, что все параметры переданы
if [ -z "$backup_url" ] || [ -z "$backup_id" ] || [ -z "$environment" ] || [ -z "$schema_id" ]; then
    error_response "Missing required parameters: backup_url=${backup_url:-empty}, backup_id=${backup_id:-empty}, environment=${environment:-empty}, schema_id=${schema_id:-empty}"
fi

# Пытаемся создать директорию с обработкой ошибок
if ! mkdir -p "$LOG_DIR" 2>/dev/null; then
    error_response "Failed to create directory $LOG_DIR. Check permissions for creating /backup_restore"
fi

echo "[$(date '+%F %T')] === Starting user restore for schema_${schema_id} ===" >> "$LOG_FILE"
echo "   BACKUP_URL:  $backup_url" >> "$LOG_FILE"
echo "   BACKUP_ID:   $backup_id" >> "$LOG_FILE"
echo "   ENVIRONMENT: $environment" >> "$LOG_FILE"
echo "   SCHEMA_ID:   $schema_id" >> "$LOG_FILE"
echo "--------------------------------------------------------" >> "$LOG_FILE"

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Проверяем существование скрипта восстановления
RESTORE_SCRIPT="/usr/local/bin/restore-user-s3.sh"
if [ ! -f "$RESTORE_SCRIPT" ]; then
    echo "[$(date '+%F %T')] ERROR: Restore script not found at $RESTORE_SCRIPT" >> "$LOG_FILE" 2>/dev/null || true
    error_response "Restore script not found at $RESTORE_SCRIPT"
fi

if [ ! -x "$RESTORE_SCRIPT" ]; then
    echo "[$(date '+%F %T')] ERROR: Restore script is not executable: $RESTORE_SCRIPT" >> "$LOG_FILE"
    error_response "Restore script is not executable: $RESTORE_SCRIPT"
fi

# Запускаем восстановление в фоновом режиме
echo "[$(date '+%F %T')] Starting background restore process..." >> "$LOG_FILE"
nohup "$RESTORE_SCRIPT" "$backup_url" "$backup_id" "$environment" "$schema_id" \
    >>"$LOG_FILE" 2>&1 &

BACKGROUND_PID=$!

# Проверяем, что процесс действительно запустился
sleep 1
if ps -p $BACKGROUND_PID > /dev/null 2>&1; then
    echo "[$(date '+%F %T')] Background restore process started successfully with PID: $BACKGROUND_PID" >> "$LOG_FILE"
else
    echo "[$(date '+%F %T')] ERROR: Background process failed to start or crashed immediately" >> "$LOG_FILE"
    error_response "Background restore process failed to start or crashed immediately. Check $LOG_FILE for details"
fi

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

log_event "$OK" "$ARGUMENTS"
RESTORE_STATUS="progress"
RESTORE_MESSAGE="User backup restore started in background (PID: $BACKGROUND_PID). Status will be sent to webhook when complete."
echo "[$(date '+%F %T')] Background process started for schema_${schema_id}" >> "$LOG_FILE"

#----------------------------------------------------------#
#                      JSON Response                       #
#----------------------------------------------------------#

JSON=$(cat <<EOF
{
  "backup_url": "$backup_url",
  "backup_id": "$backup_id",
  "schema_id": "$schema_id",
  "status": "$RESTORE_STATUS",
  "message": "$RESTORE_MESSAGE",
  "pid": "$BACKGROUND_PID"
}
EOF
)

echo "$JSON"
exit 0
